services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: inksight-backend
    environment:
      - USE_LOCAL_MODEL=${USE_LOCAL_MODEL}
      - AGENT_LLM_MODEL=${AGENT_LLM_MODEL}
      - AGENT_API_KEY=${AGENT_API_KEY}
      - AGENT_BASE_URL=${AGENT_BASE_URL}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY:-}
      - LANGCHAIN_PROJECT=${LANGCHAIN_PROJECT:-inksight}
      - HOST=0.0.0.0
      - PORT=8000
    volumes:
      - ./backend/uploads:/app/uploads
      - ./backend/users.json:/app/users.json
    networks:
      - inksight-network
      - traefik-proxy-net
    restart: unless-stopped

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`inksight.ru`) && PathPrefix(`/api`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls=true"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.api.priority=100"
      - "traefik.http.services.api.loadbalancer.server.port=8000"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 20s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: inksight-frontend
    networks:
      - inksight-network
      - traefik-proxy-net
    restart: unless-stopped
    environment:
      - VITE_API_URL=https://inksight.ru/api
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.web.rule=Host(`inksight.ru`) && !PathPrefix(`/api`)"
      - "traefik.http.routers.web.entrypoints=websecure"
      - "traefik.http.routers.web.tls=true"
      - "traefik.http.routers.web.tls.certresolver=letsencrypt"
      - "traefik.http.routers.web.priority=1"
      - "traefik.http.services.web.loadbalancer.server.port=3000"

    depends_on:
      backend:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 20s
      timeout: 10s
      retries: 3
      start_period: 10s


networks:
  inksight-network:
    name: inksight-network
  traefik-proxy-net:
    external: true
